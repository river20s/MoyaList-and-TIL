# 해시 키 재배치(rehash)문제

> 안정 해시 설계란 scale out을 위해 요청 또는 데이터를 서버에 균등하게 나누는데 사용하는 기술이다. 안정 해시는 **해시 키 재배치 문제**를 해결하기 위해 사용할 수 있다.

N개의 캐시 서버가 있다고 가정한다. 이 서버들에 부하를 균등하게 나누는 보편적 방법은 다음 해시 함수를 사용하는 것이다.
$$
serverIndex=hash(key)\bmod N
$$
예를 들어 총 4대의 서버를 사용한다고 가정해보자. 다음은 주어진 각각의 키에 대해 해시 값과 서버 인덱스를 계산한 것이다.

| 키   | 해시     | 해시 % 4 (서버 인덱스) |
| ---- | -------- | ---------------------- |
| key0 | 18358617 | 1                      |
| key1 | 26143584 | 0                      |
| key2 | 18131146 | 2                      |
| key3 | 35863496 | 0                      |
| key4 | 34085809 | 1                      |
| key5 | 27581703 | 3                      |
| key6 | 38164978 | 2                      |
| key7 | 22530351 | 3                      |

특정 키가 보관된 서버는 f(ket) % 4 한 것과 같다. 예를 들어 hash(key0) % 4 = 1이면, 클라이언트는 캐시에 보관된 데이터를 가져오기 위해 서버 1에 접속해야 한다. 

![image](https://github.com/user-attachments/assets/8b8ddeb5-3b72-4a75-b99a-790c77ec5b46)

위 그림은 예시에서 키 값이 서버에 어떻게 분산되는지 표현한 것이다.

이 방법은 **서버 풀(server pool)**의 크기가 고정되어 있을 때, **데이터 분포가 균등할 때**는 잘 동작한다.

하지만 **서버가 추가되거나**, **기존의 서버가 삭제되면** 문제가 생긴다. 예를 들어 *1번 서버가 장애를 일으켜 동작을 중단*했다고 하자. 그러면 서버 풀의 크기는 3으로 변한다. 그 결과로 키에 대한 해시 값은 변하지 않지만 모듈러 연산을 적용하여 계산한 서버 인덱스 값은 달라질 것인데, 서버 수가 1만큼 줄어들어 N=3이 되었기 때문이다.



| 키   | 해시     | 해시 % 3 (서버 인덱스) |
| ---- | -------- | ---------------------- |
| key0 | 18358617 | 0                      |
| key1 | 26143584 | 0                      |
| key2 | 18131146 | 1                      |
| key3 | 35863496 | 2                      |
| key4 | 34085809 | 1                      |
| key5 | 27581703 | 0                      |
| key6 | 38164978 | 1                      |
| key7 | 22530351 | 0                      |



아래 그림은 키 분포를 보여준다. <br>

![image](https://github.com/user-attachments/assets/52bd788a-7132-4547-b975-47a37bc15151)

장애가 발생한 1번 서버에 보관된 키 뿐만 아니라 대부분의 키가 재분배 되었다. 따라서 1번 서버가 죽어버리면, 대부분의 캐시 클라이언트는 필요한 데이터가없는 엉뚱한 서버테 접속하게 된다는 뜻이다. 그 결과 대규모 캐시 미스(cache miss)가 발생하게 될 것이다. 

이런 문제를 해결하기 위해 **안정 해시**를 사용할 수 있다.

---

**출처**

<가상 면접 사례로 배우는 대규모 시스템 설계 기초>, 알렉스 쉬 지음, 인사이트.